<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›¸ç°¿è¤‡åˆæœå°‹å™¨ | ç¶ è‰²è«è˜­è¿ªé¢¨æ ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet åœ°åœ–å¥—ä»¶ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* --------------------- GREEN MORANDI THEME --------------------- */
        :root {
            --bg-main: #F9F7F3; /* æ·ºç±³ç™½/ç°ç™½ */
            --color-text: #333333;
            --accent-green: #A8B5A3; /* æŸ”å’Œç°ç¶  (Primary) */
            --accent-green-dark: #7D8B7E; /* æ²‰ç©©æ·±ç¶  */
            --accent-pink: #E4C7C2; /* æ·ºæŸ”ç²‰ (Secondary) */
            --accent-pink-dark: #DDA0A0; /* æ·ºæš–æ©˜/ä¹¾ç‡¥ç«ç‘° (Success/Highlight) */
            --color-gray-dark: #4B5563; /* Gray-600 */
        }

        body {
            background-color: var(--bg-main);
        }
        
        #map { height: 200px; width: 100%; z-index: 1; }
        .leaflet-pane { z-index: 1 !important; }
        .leaflet-control { z-index: 2 !important; }
        
        /* é€šç”¨ Checkbox æ¨£å¼ (äººç‰© & æ¨™ç±¤) */
        .checkbox-wrapper input:checked + div {
            /* Checkbox: ä½¿ç”¨æ·ºæŸ”ç²‰ä½œç‚ºåº•è‰²ï¼ŒæŸ”å’Œç°ç¶ ä½œç‚ºé‚Šæ¡† */
            background-color: var(--accent-pink);
            border-color: var(--accent-green);
            color: var(--color-text);
            box-shadow: 0 1px 4px 0 rgba(168, 181, 163, 0.2);
        }
        .checkbox-wrapper input:checked + div i {
            color: var(--accent-green-dark); /* æ·±ç¶ è‰²æ‰“å‹¾ */
        }

        /* æ¨™ç±¤å°ˆç”¨å¾®èª¿ */
        .tag-wrapper input:checked + div {
            /* Tag: ä½¿ç”¨æŸ”å’Œç°ç¶ ä½œç‚ºåº•è‰²ï¼Œæ·ºæŸ”ç²‰ä½œç‚ºé‚Šæ¡† */
            background-color: var(--accent-green);
            border-color: var(--accent-pink);
            color: var(--color-text);
        }
        .tag-wrapper input:checked + div i {
            color: var(--accent-pink-dark); /* æ·ºæš–æ©˜åœ–ç¤º */
        }

        /* ç°¡å–®çš„ Modal å‹•ç•« */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }

        /* ç‹€æ…‹æ¬„é¡è‰²èª¿æ•´ */
        .status-error { color: #DC2626 !important; }
        .status-loading { color: var(--accent-green-dark) !important; }
        .status-success { color: var(--accent-pink-dark) !important; }

        /* è¼¸å…¥æ¡† focus èª¿æ•´ */
        input:focus {
            outline: none !important;
            border-color: var(--accent-green) !important;
            box-shadow: 0 0 0 3px rgba(168, 181, 163, 0.3) !important;
        }

        /* æŒ‰éˆ•é¡è‰²èª¿æ•´ */
        .btn-primary {
            background-color: var(--accent-green-dark);
            color: var(--bg-main);
            box-shadow: 0 4px 0 0 var(--accent-pink-dark);
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--accent-green);
            box-shadow: 0 4px 0 0 var(--accent-pink);
        }
        .btn-primary:active {
            transform: translateY(2px);
            box-shadow: none;
        }
        .btn-secondary {
            border-color: var(--accent-pink);
            color: var(--color-gray-dark);
        }
        .btn-secondary:hover {
            background-color: var(--accent-pink);
            border-color: var(--accent-pink-dark);
            color: var(--color-text);
        }
        .btn-link {
            color: var(--accent-green-dark);
        }
        .btn-link:hover {
            color: var(--accent-pink-dark);
        }
    </style>
</head>
<body class="bg-[var(--bg-main)] flex items-center justify-center min-h-screen p-4 text-[var(--color-text)]">

    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden flex flex-col pb-6 border border-gray-200">
        
        <!-- æ¨™é¡Œå€ (ä½¿ç”¨ Accent-Green æ¼¸è®Š) -->
        <div class="bg-gradient-to-r from-[var(--accent-green)] to-[var(--accent-green-dark)] p-4 text-center z-10 relative shadow-md">
            <h1 class="text-[var(--bg-main)] text-lg font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-users-viewfinder"></i> ç›¸ç°¿è¤‡åˆæœå°‹å™¨
            </h1>
            <p class="text-white text-xs mt-1 opacity-80">Morandi Green Style</p>
        </div>

        <!-- åœ°åœ–é è¦½å€ -->
        <div id="map" class="bg-gray-200 border-b border-gray-300"></div>

        <div class="p-5 space-y-5">

            <!-- æ­¥é©Ÿ 1: åœ°é» -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Step 1: è¨­å®šåœ°é»</label>
                
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-map-pin absolute left-3 top-3 text-[var(--accent-green)]"></i>
                        <input id="location-input" type="text" placeholder="ä¾‹å¦‚: ç¥æˆ¶å¸‚" 
                            class="w-full appearance-none border border-gray-300 rounded-lg py-2 pl-10 pr-4 text-[var(--color-text)] focus:ring-0 shadow-sm transition">
                    </div>
                    <button onclick="searchGPS()" id="gps-btn"
                        class="bg-white border border-gray-300 text-[var(--color-gray-dark)] px-3 rounded-lg hover:bg-gray-50 hover:text-[var(--accent-green)] transition shadow-sm" title="å®šä½ç›®å‰ä½ç½®">
                        <i class="fa-solid fa-location-crosshairs text-lg"></i>
                    </button>
                </div>
                <div id="status-bar" class="text-xs text-gray-500 min-h-[1.5rem] flex items-center gap-1">
                    <i class="fa-solid fa-circle-info text-[var(--accent-green)]"></i> è«‹è¼¸å…¥åœ°é»æˆ–é»æ“Šå®šä½
                </div>
            </div>

            <div class="border-t border-gray-100"></div>

            <!-- æ­¥é©Ÿ 2: é¸æ“‡äººç‰© -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Step 2: åŒ…å«äººç‰©</label>
                
                <div class="grid grid-cols-2 gap-3">
                    <label class="checkbox-wrapper cursor-pointer relative">
                        <input type="checkbox" name="person" value="è”£ç¿Šé½Š" class="peer sr-only">
                        <div class="border border-gray-200 rounded-lg p-3 flex items-center justify-between transition hover:bg-gray-50">
                            <span class="font-medium text-[var(--color-gray-dark)]">è”£ç¿Šé½Š</span>
                            <i class="fa-solid fa-check text-[var(--accent-green)] opacity-0 peer-checked:opacity-100"></i>
                        </div>
                    </label>

                    <label class="checkbox-wrapper cursor-pointer relative">
                        <input type="checkbox" name="person" value="è”£å®¥æ˜‡" class="peer sr-only">
                        <div class="border border-gray-200 rounded-lg p-3 flex items-center justify-between transition hover:bg-gray-50">
                            <span class="font-medium text-[var(--color-gray-dark)]">è”£å®¥æ˜‡</span>
                            <i class="fa-solid fa-check text-[var(--accent-green)] opacity-0 peer-checked:opacity-100"></i>
                        </div>
                    </label>

                    <label class="checkbox-wrapper cursor-pointer relative">
                        <input type="checkbox" name="person" value="é™³æ¦®èŠ³" class="peer sr-only">
                        <div class="border border-gray-200 rounded-lg p-3 flex items-center justify-between transition hover:bg-gray-50">
                            <span class="font-medium text-[var(--color-gray-dark)]">é™³æ¦®èŠ³</span>
                            <i class="fa-solid fa-check text-[var(--accent-green)] opacity-0 peer-checked:opacity-100"></i>
                        </div>
                    </label>

                    <label class="checkbox-wrapper cursor-pointer relative">
                        <input type="checkbox" name="person" value="è”£å®—æ†" class="peer sr-only">
                        <div class="border border-gray-200 rounded-lg p-3 flex items-center justify-between transition hover:bg-gray-50">
                            <span class="font-medium text-[var(--color-gray-dark)]">è”£å®—æ†</span>
                            <i class="fa-solid fa-check text-[var(--accent-green)] opacity-0 peer-checked:opacity-100"></i>
                        </div>
                    </label>
                </div>
            </div>

            <div class="border-t border-gray-100"></div>

            <!-- æ­¥é©Ÿ 3: å¸¸ç”¨æ¨™ç±¤ (æ–°å¢) -->
            <div class="space-y-3">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Step 3: å¸¸ç”¨æ¨™ç±¤ (é¸å¡«)</label>
                
                <!-- å¿ƒæƒ…èˆ‡æ´»å‹• -->
                <div>
                    <span class="text-[10px] text-gray-400 font-bold mb-1 block pl-1">å¿ƒæƒ…èˆ‡æ´»å‹•</span>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="tag-wrapper cursor-pointer relative">
                            <input type="checkbox" name="keyword" value="fun" class="peer sr-only">
                            <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                <i class="fa-solid fa-face-laugh-beam text-lg mb-1"></i>
                                <span class="text-[10px] font-medium">fun</span>
                            </div>
                        </label>
                        <label class="tag-wrapper cursor-pointer relative">
                            <input type="checkbox" name="keyword" value="smile" class="peer sr-only">
                            <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                <i class="fa-solid fa-face-smile text-lg mb-1"></i>
                                <span class="text-[10px] font-medium">smile</span>
                            </div>
                        </label>
                        <label class="tag-wrapper cursor-pointer relative">
                            <input type="checkbox" name="keyword" value="play" class="peer sr-only">
                            <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                <i class="fa-solid fa-person-running text-lg mb-1"></i>
                                <span class="text-[10px] font-medium">play</span>
                            </div>
                        </label>
                        <label class="tag-wrapper cursor-pointer relative">
                            <input type="checkbox" name="keyword" value="holiday" class="peer sr-only">
                            <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                <i class="fa-solid fa-plane-departure text-lg mb-1"></i>
                                <span class="text-[10px] font-medium">holiday</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- æ™¯é»èˆ‡è‡ªç„¶ -->
                <div>
                    <span class="text-[10px] text-gray-400 font-bold mb-1 block pl-1">æ™¯é»èˆ‡è‡ªç„¶</span>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="tag-wrapper cursor-pointer relative">
                            <input type="checkbox" name="keyword" value="river" class="peer sr-only">
                            <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                <i class="fa-solid fa-water text-lg mb-1"></i>
                                <span class="text-[10px] font-medium">river</span>
                            </div>
                        </label>
                        <label class="tag-wrapper cursor-pointer relative">
                            <input type="checkbox" name="keyword" value="beach" class="peer sr-only">
                            <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                <i class="fa-solid fa-umbrella-beach text-lg mb-1"></i>
                                <span class="text-[10px] font-medium">beach</span>
                            </div>
                        </label>
                        <label class="tag-wrapper cursor-pointer relative">
                            <input type="checkbox" name="keyword" value="hotel" class="peer sr-only">
                            <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                <i class="fa-solid fa-hotel text-lg mb-1"></i>
                                <span class="text-[10px] font-medium">hotel</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- ç¾é£Ÿèˆ‡å…¶ä»– -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <span class="text-[10px] text-gray-400 font-bold mb-1 block pl-1">ç¾é£Ÿ</span>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="tag-wrapper cursor-pointer relative">
                                <input type="checkbox" name="keyword" value="eat" class="peer sr-only">
                                <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                    <i class="fa-solid fa-utensils text-lg mb-1"></i>
                                    <span class="text-[10px] font-medium">eat</span>
                                </div>
                            </label>
                            <label class="tag-wrapper cursor-pointer relative">
                                <input type="checkbox" name="keyword" value="food" class="peer sr-only">
                                <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                    <i class="fa-solid fa-burger text-lg mb-1"></i>
                                    <span class="text-[10px] font-medium">food</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div>
                        <span class="text-[10px] text-gray-400 font-bold mb-1 block pl-1">ç²¾é¸èˆ‡ ID</span>
                        <div class="grid grid-cols-3 gap-2">
                            <label class="tag-wrapper cursor-pointer relative">
                                <input type="checkbox" name="keyword" value="masterpiece" class="peer sr-only">
                                <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                    <i class="fa-solid fa-crown text-lg mb-1"></i>
                                    <span class="text-[10px] font-medium text-center leading-tight">master<br>piece</span>
                                </div>
                            </label>
                            <label class="tag-wrapper cursor-pointer relative">
                                <input type="checkbox" name="keyword" value="ä½œå“" class="peer sr-only">
                                <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                    <i class="fa-solid fa-palette text-lg mb-1"></i>
                                    <span class="text-[10px] font-medium">ä½œå“</span>
                                </div>
                            </label>
                            <label class="tag-wrapper cursor-pointer relative">
                                <input type="checkbox" name="keyword" value="id-caad" class="peer sr-only">
                                <div class="border border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center transition hover:bg-gray-50 h-full">
                                    <i class="fa-solid fa-id-card text-lg mb-1"></i>
                                    <span class="text-[10px] font-medium text-center leading-tight">id<br>caad</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>


            <!-- æ­¥é©Ÿ 4: è¡Œå‹•æŒ‰éˆ•å€ -->
            <div class="pt-2 space-y-3">
                <!-- æ‰‹æ©Ÿç‰ˆæŒ‰éˆ• -->
                <button onclick="executeSearch()" 
                    class="w-full btn-primary font-bold py-3.5 rounded-xl transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-mobile-screen-button"></i>
                    <span>æœå°‹ç›¸ç°¿ (æ‰‹æ©Ÿæ¨è–¦)</span>
                </button>

                <!-- é›»è…¦ç‰ˆåœ°åœ–æŒ‰éˆ• -->
                <div>
                    <a href="https://photos.google.com/places" target="_blank"
                       class="w-full bg-white border-2 btn-secondary font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-laptop"></i>
                        <span>æ‰“é–‹åœ°åœ–æ¨¡å¼ (é›»è…¦å°ˆç”¨)</span>
                    </a>
                    
                    <!-- å¹«åŠ©æŒ‰éˆ• -->
                    <div class="text-center mt-2">
                        <button onclick="toggleModal('help-modal')" class="text-xs btn-link underline flex items-center justify-center gap-1 mx-auto">
                            <i class="fa-solid fa-circle-question"></i> æ‰¾ä¸åˆ°ã€Œæ¢ç´¢ã€æˆ–ã€Œåœ°é»ã€ï¼Ÿ
                        </button>
                    </div>
                </div>
            </div>

            <!-- çµæœé¡¯ç¤ºèˆ‡æ•‘æ´é€£çµ -->
            <div id="result-area" class="hidden bg-gray-50 p-3 rounded-lg border border-gray-200 text-center space-y-2 mt-2">
                <p class="text-xs text-gray-500">å°‡æœå°‹ï¼š<span id="search-query-preview" class="font-bold text-[var(--color-gray-dark)]">--</span></p>
                <a id="final-link" href="#" target="_blank" class="text-sm btn-link underline font-medium block">
                    <i class="fa-solid fa-up-right-from-square"></i> é»æ­¤é–‹å•Ÿæœå°‹çµæœ
                </a>
            </div>

        </div>
    </div>

    <!-- å¹«åŠ©è¦–çª— Modal -->
    <div id="help-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal('help-modal')"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-lg z-50 overflow-y-auto border border-gray-200">
            
            <div class="modal-content py-4 text-left px-6">
                <!-- Title -->
                <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                    <p class="text-lg font-bold text-[var(--color-text)]">é›»è…¦ç‰ˆåœ°åœ–åœ¨å“ªè£¡ï¼Ÿ</p>
                    <div class="modal-close cursor-pointer z-50" onclick="toggleModal('help-modal')">
                        <i class="fa-solid fa-xmark text-gray-500 hover:text-[var(--accent-pink-dark)]"></i>
                    </div>
                </div>

                <!-- Body -->
                <div class="py-4 space-y-4 text-gray-600 text-sm">
                    <p>Google ç›¸ç°¿é›»è…¦ç‰ˆæœ‰æ™‚æœƒå› ç‚ºç€è¦½å™¨è¨­å®šè€Œéš±è—åœ°åœ–ï¼š</p>
                    
                    <!-- æ–°å¢ï¼šåœ°åœ–æ¶ˆå¤±çš„è§£æ±ºæ–¹æ¡ˆ -->
                    <div class="bg-red-50 p-3 rounded-lg border border-red-300">
                        <p class="font-bold text-red-800 mb-1"><i class="fa-solid fa-triangle-exclamation text-red-500"></i> æˆ‘åˆ°äº†ã€Œåœ°é»ã€ä½†æ²’çœ‹åˆ°åœ°åœ–ï¼Ÿ</p>
                        <p class="mb-2">é€™é€šå¸¸æ˜¯å› ç‚ºç€è¦½å™¨çš„<strong>ã€Œç¡¬é«”åŠ é€Ÿã€</strong>è¢«é—œé–‰äº†ã€‚</p>
                        
                        <div class="space-y-3">
                            <div>
                                <p class="font-bold text-xs text-[var(--color-text)]"><i class="fa-brands fa-chrome text-[var(--accent-green-dark)]"></i> Google Chrome:</p>
                                <ul class="list-disc pl-5 text-xs text-gray-700">
                                    <li><strong>è¨­å®š</strong> > <strong>ç³»çµ±</strong></li>
                                    <li>é–‹å•Ÿ <strong>ã€Œåœ¨å¯ç”¨æ™‚ä½¿ç”¨åœ–å½¢åŠ é€Ÿã€</strong></li>
                                </ul>
                            </div>
                            
                            <div>
                                <p class="font-bold text-xs text-[var(--color-text)]"><i class="fa-brands fa-edge text-[var(--accent-green-dark)]"></i> Microsoft Edge:</p>
                                <ul class="list-disc pl-5 text-xs text-gray-700">
                                    <li><strong>è¨­å®š</strong> > <strong>ç³»çµ±èˆ‡æ•ˆèƒ½</strong></li>
                                    <li>é–‹å•Ÿ <strong>ã€Œåœ¨å¯ç”¨æ™‚ä½¿ç”¨åœ–å½¢åŠ é€Ÿã€</strong></li>
                                </ul>
                            </div>
                        </div>
                        <p class="text-xs text-red-600 mt-2 font-bold">* è¨­å®šå¾Œè«‹å‹™å¿…é‡æ–°å•Ÿå‹•ç€è¦½å™¨ï¼</p>
                    </div>

                    <div class="bg-gray-100 p-3 rounded-lg border border-gray-300">
                        <p class="font-bold text-[var(--color-text)] mb-1">ä¸€èˆ¬é€²å…¥æ–¹å¼</p>
                        <p>å·¦å´é¸å–® <span class="text-[var(--accent-green-dark)] font-bold">ã€Œæ”¶è—ã€</span> > <span class="text-[var(--accent-green-dark)] font-bold">ã€Œåœ°é»ã€</span></p>
                    </div>
                    
                </div>

                <!-- Footer -->
                <div class="flex justify-end pt-2">
                    <button class="px-4 py-2 btn-primary rounded-lg" onclick="toggleModal('help-modal')">çŸ¥é“äº†</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var map = L.map('map').setView([23.973875, 120.982024], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
        var currentMarker = null;

        // åˆå§‹åŒ–æ™‚ï¼Œæª¢æŸ¥ä¸¦è¨­ç½® GPS/åœ°åç‹€æ…‹
        document.addEventListener('DOMContentLoaded', () => {
             setStatus('è«‹è¼¸å…¥åœ°é»æˆ–é»æ“Šå®šä½');
             map.invalidateSize();
        });


        function setStatus(msg, type = 'normal') {
            const el = document.getElementById('status-bar');
            let iconClass = '';
            let colorClass = '';
            
            switch(type) {
                case 'error':
                    iconClass = 'fa-solid fa-triangle-exclamation';
                    colorClass = 'status-error';
                    break;
                case 'loading':
                    iconClass = 'fa-solid fa-spinner fa-spin';
                    colorClass = 'status-loading';
                    break;
                case 'success':
                    iconClass = 'fa-solid fa-circle-check';
                    colorClass = 'status-success';
                    break;
                case 'normal':
                default:
                    iconClass = 'fa-solid fa-circle-info';
                    colorClass = 'text-gray-500';
                    break;
            }

            el.innerHTML = `<i class="${iconClass}"></i> ${msg}`;
            el.className = `text-xs min-h-[1.5rem] flex items-center gap-1 ${colorClass}`;
        }

        function updateMap(lat, lon, zoom = 13) {
            if (currentMarker) map.removeLayer(currentMarker);
            map.setView([lat, lon], zoom);
            currentMarker = L.marker([lat, lon]).addTo(map);
            map.invalidateSize();
        }

        function searchGPS() {
            setStatus('GPS å®šä½ä¸­ (ç´„éœ€ 10 ç§’)...', 'loading');
            document.getElementById('gps-btn').disabled = true;
            
            if (!navigator.geolocation) {
                setStatus('ç€è¦½å™¨ä¸æ”¯æ´ GPS', 'error');
                document.getElementById('gps-btn').disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    updateMap(lat, lon, 15);
                    setStatus('è½‰æ›åœ°å€ä¸­...', 'loading');

                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14`)
                        .then(res => res.json())
                        .then(data => {
                            let place = data.address ? (data.address.city || data.address.town || data.address.district || "") : "";
                            if (place) {
                                document.getElementById('location-input').value = place;
                                setStatus(`ğŸ“ å·²å®šä½ï¼š${place}`, 'success');
                            } else {
                                document.getElementById('location-input').value = "æˆ‘çš„ä½ç½®";
                                setStatus('å®šä½æˆåŠŸï¼Œä½†ç„¡æ³•è¾¨è­˜åœ°åã€‚', 'success');
                            }
                            document.getElementById('gps-btn').disabled = false;
                        })
                        .catch(err => {
                            setStatus('ç¶²è·¯éŒ¯èª¤æˆ–æœå‹™æš«æ™‚ç„¡å›æ‡‰', 'error');
                            document.getElementById('gps-btn').disabled = false;
                        });
                },
                (err) => {
                    let errMsg = 'å®šä½å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™';
                    if (err.code === err.PERMISSION_DENIED) {
                        errMsg = 'æ‚¨å·²æ‹’çµ•å®šä½æ¬Šé™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åœ°é»ã€‚';
                    } else if (err.code === err.TIMEOUT) {
                        errMsg = 'å®šä½è¶…æ™‚ï¼Œè«‹é‡è©¦æˆ–æ‰‹å‹•è¼¸å…¥ã€‚';
                    }
                    setStatus(errMsg, 'error');
                    document.getElementById('gps-btn').disabled = false;
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
            );
        }

        function executeSearch() {
            const locationInput = document.getElementById('location-input');
            let locationVal = locationInput.value.trim();

            // æŠ“å–äººç‰©
            const personCheckboxes = document.querySelectorAll('input[name="person"]:checked');
            let selectedItems = [];
            personCheckboxes.forEach((cb) => selectedItems.push(cb.value));

            // æŠ“å–æ¨™ç±¤
            const keywordCheckboxes = document.querySelectorAll('input[name="keyword"]:checked');
            keywordCheckboxes.forEach((cb) => selectedItems.push(cb.value));

            if (!locationVal && selectedItems.length === 0) {
                setStatus('è«‹è¼¸å…¥åœ°é»æˆ–é¸æ“‡æ¢ä»¶ï¼', 'error');
                locationInput.focus();
                return;
            }

            // æ›´æ–°åœ°åœ– (å¦‚æœæœ‰è¼¸å…¥åœ°é»)
            if (locationVal) {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationVal)}`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.length > 0) updateMap(parseFloat(data[0].lat), parseFloat(data[0].lon));
                    map.invalidateSize(); // ç¢ºä¿åœ°åœ–åœ¨å½ˆå‡ºæ™‚èƒ½æ­£ç¢ºæ¸²æŸ“
                });
            }
            
            // çµ„åˆæŸ¥è©¢å­—ä¸²
            let finalQuery = locationVal;
            if (selectedItems.length > 0) {
                // å¦‚æœæœ‰åœ°é»ï¼ŒåŠ ç©ºæ ¼å¾Œæ¥é—œéµå­—ï¼›å¦‚æœæ²’åœ°é»ï¼Œç›´æ¥æ”¾é—œéµå­—
                finalQuery = finalQuery ? (finalQuery + " " + selectedItems.join(" ")) : selectedItems.join(" ");
            }

            const url = `https://photos.google.com/search/${encodeURIComponent(finalQuery)}`;
            
            document.getElementById('search-query-preview').innerText = finalQuery;
            document.getElementById('final-link').href = url;
            
            const resultArea = document.getElementById('result-area');
            resultArea.classList.remove('hidden');
            resultArea.classList.add('bg-[var(--accent-pink)]/20', 'border-[var(--accent-pink)]'); // æ–°å¢è«è˜­è¿ªæ¨£å¼

            setStatus('æ­£åœ¨é–‹å•Ÿç›¸ç°¿...', 'success');
            setTimeout(() => { window.open(url, '_blank'); }, 500);
        }

        function toggleModal(modalID){
            document.getElementById(modalID).classList.toggle("opacity-0");
            document.getElementById(modalID).classList.toggle("pointer-events-none");
            document.body.classList.toggle("modal-active");
        }
    </script>
</body>
</html>
