<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›¸ç°¿è¤‡åˆæœå°‹å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet åœ°åœ–å¥—ä»¶ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        #map { height: 200px; width: 100%; z-index: 1; }
        .leaflet-pane { z-index: 1 !important; }
        .leaflet-control { z-index: 2 !important; }
        
        /* Checkbox è‡ªå®šç¾©æ¨£å¼ */
        .checkbox-wrapper input:checked + div {
            background-color: #eff6ff;
            border-color: #3b82f6;
            color: #1d4ed8;
        }
        .checkbox-wrapper input:checked + div .check-icon {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden flex flex-col pb-6">
        
        <!-- æ¨™é¡Œå€ -->
        <div class="bg-blue-600 p-4 text-center z-10 relative shadow-md">
            <h1 class="text-white text-lg font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-users-viewfinder"></i> ç›¸ç°¿è¤‡åˆæœå°‹å™¨
            </h1>
        </div>

        <!-- åœ°åœ–é è¦½å€ -->
        <div id="map" class="bg-gray-200 border-b border-gray-300"></div>

        <div class="p-5 space-y-5">

            <!-- æ­¥é©Ÿ 1: åœ°é» -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Step 1: è¨­å®šåœ°é»</label>
                
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-map-pin absolute left-3 top-3 text-gray-400"></i>
                        <input id="location-input" type="text" placeholder="ä¾‹å¦‚: ç¥æˆ¶å¸‚" 
                            class="w-full appearance-none border border-gray-300 rounded-lg py-2 pl-10 pr-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm transition">
                    </div>
                    <button onclick="searchGPS()" id="gps-btn"
                        class="bg-white border border-gray-300 text-gray-700 px-3 rounded-lg hover:bg-gray-50 hover:text-blue-600 transition shadow-sm" title="å®šä½ç›®å‰ä½ç½®">
                        <i class="fa-solid fa-location-crosshairs text-lg"></i>
                    </button>
                </div>
                <!-- ç‹€æ…‹é¡¯ç¤ºå€ -->
                <div id="status-bar" class="text-xs text-gray-500 min-h-[1.5rem] flex items-center gap-1">
                    <i class="fa-solid fa-circle-info text-blue-400"></i> è«‹è¼¸å…¥åœ°é»æˆ–é»æ“Šå³å´å®šä½æŒ‰éˆ•
                </div>
            </div>

            <div class="border-t border-gray-100"></div>

            <!-- æ­¥é©Ÿ 2: é¸æ“‡äººç‰© -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Step 2: åŒ…å«äººç‰© (å¯å¤šé¸)</label>
                
                <div class="grid grid-cols-2 gap-3">
                    <label class="checkbox-wrapper cursor-pointer relative">
                        <input type="checkbox" value="è”£ç¿Šé½Š" class="peer sr-only">
                        <div class="border border-gray-200 rounded-lg p-3 flex items-center justify-between transition hover:bg-gray-50">
                            <span class="font-medium text-gray-700">è”£ç¿Šé½Š</span>
                            <i class="fa-solid fa-check check-icon text-blue-600 opacity-0 transition-opacity"></i>
                        </div>
                    </label>

                    <label class="checkbox-wrapper cursor-pointer relative">
                        <input type="checkbox" value="è”£å®¥æ˜‡" class="peer sr-only">
                        <div class="border border-gray-200 rounded-lg p-3 flex items-center justify-between transition hover:bg-gray-50">
                            <span class="font-medium text-gray-700">è”£å®¥æ˜‡</span>
                            <i class="fa-solid fa-check check-icon text-blue-600 opacity-0 transition-opacity"></i>
                        </div>
                    </label>

                    <label class="checkbox-wrapper cursor-pointer relative">
                        <input type="checkbox" value="é™³æ¦®èŠ³" class="peer sr-only">
                        <div class="border border-gray-200 rounded-lg p-3 flex items-center justify-between transition hover:bg-gray-50">
                            <span class="font-medium text-gray-700">é™³æ¦®èŠ³</span>
                            <i class="fa-solid fa-check check-icon text-blue-600 opacity-0 transition-opacity"></i>
                        </div>
                    </label>

                    <label class="checkbox-wrapper cursor-pointer relative">
                        <input type="checkbox" value="è”£å®—æ†" class="peer sr-only">
                        <div class="border border-gray-200 rounded-lg p-3 flex items-center justify-between transition hover:bg-gray-50">
                            <span class="font-medium text-gray-700">è”£å®—æ†</span>
                            <i class="fa-solid fa-check check-icon text-blue-600 opacity-0 transition-opacity"></i>
                        </div>
                    </label>
                </div>
            </div>

            <!-- æ­¥é©Ÿ 3: é€å‡ºæœå°‹ -->
            <div class="pt-2">
                <button onclick="executeSearch()" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 text-lg">
                    <i class="fa-brands fa-google"></i>
                    <span>æœå°‹ç›¸ç°¿</span>
                </button>
            </div>

            <!-- æœå°‹é è¦½èˆ‡æ•‘æ´é€£çµ -->
            <div id="result-area" class="hidden bg-gray-50 p-3 rounded-lg border border-gray-200 text-center space-y-2">
                <p class="text-xs text-gray-500">å°‡æœå°‹ï¼š<span id="search-query-preview" class="font-bold text-gray-800">--</span></p>
                <a id="final-link" href="#" target="_blank" class="text-sm text-blue-600 underline font-medium block p-2 bg-white rounded border border-blue-100">
                    <i class="fa-solid fa-up-right-from-square"></i> é»æ­¤é–‹å•Ÿç›¸ç°¿
                </a>
            </div>

        </div>
    </div>

    <script>
        // åˆå§‹åŒ–åœ°åœ– (é è¨­è¦–é‡: å°ç£)
        var map = L.map('map').setView([23.973875, 120.982024], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OSM'
        }).addTo(map);
        var currentMarker = null;

        // ç‹€æ…‹æ›´æ–°
        function setStatus(msg, type = 'normal') {
            const el = document.getElementById('status-bar');
            let colorClass = 'text-gray-500';
            let icon = '<i class="fa-solid fa-info-circle"></i>';

            if (type === 'error') {
                colorClass = 'text-red-500 font-bold';
                icon = '<i class="fa-solid fa-triangle-exclamation"></i>';
            } else if (type === 'success') {
                colorClass = 'text-green-600 font-bold';
                icon = '<i class="fa-solid fa-check-circle"></i>';
            } else if (type === 'loading') {
                colorClass = 'text-blue-600';
                icon = '<i class="fa-solid fa-spinner fa-spin"></i>';
            }

            el.innerHTML = `${icon} ${msg}`;
            el.className = `text-xs min-h-[1.5rem] flex items-center gap-1 ${colorClass}`;
        }

        // æ›´æ–°åœ°åœ–ä½ç½®
        function updateMap(lat, lon, zoom = 13) {
            if (currentMarker) map.removeLayer(currentMarker);
            map.setView([lat, lon], zoom);
            currentMarker = L.marker([lat, lon]).addTo(map);
            map.invalidateSize();
        }

        // --- åŠŸèƒ½ A: GPS å®šä½ (å¢å¼·ç‰ˆ) ---
        function searchGPS() {
            setStatus('GPS å®šä½ä¸­ (è«‹ç¨å€™ç´„ 10 ç§’)...', 'loading');
            document.getElementById('gps-btn').disabled = true;
            
            if (!navigator.geolocation) {
                setStatus('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ GPS', 'error');
                document.getElementById('gps-btn').disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                // æˆåŠŸå›å‘¼
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    updateMap(lat, lon, 15);
                    setStatus('å®šä½æˆåŠŸï¼æ­£åœ¨è½‰æ›åœ°å€...', 'loading');

                    // åå‘åœ°ç†ç·¨ç¢¼
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14`)
                        .then(res => res.json())
                        .then(data => {
                            let place = "";
                            if (data.address) {
                                place = data.address.city || 
                                        data.address.town || 
                                        data.address.district || 
                                        data.address.county || 
                                        data.address.state || "";
                            }
                            
                            if (place) {
                                document.getElementById('location-input').value = place;
                                setStatus(`ğŸ“ å·²å®šä½ï¼š${place}`, 'success');
                            } else {
                                // å¦‚æœæ‰¾ä¸åˆ°åå­—ï¼Œå¡«å…¥åº§æ¨™å‚™ç”¨
                                document.getElementById('location-input').value = "æˆ‘çš„ä½ç½®";
                                setStatus('ç„¡æ³•è¾¨è­˜åœ°åï¼Œè«‹æ‰‹å‹•ç¢ºèª', 'error');
                            }
                            document.getElementById('gps-btn').disabled = false;
                        })
                        .catch(err => {
                            setStatus('ç¶²è·¯ä¸ç©©ï¼Œç„¡æ³•è½‰æ›åœ°å€', 'error');
                            document.getElementById('gps-btn').disabled = false;
                        });
                },
                // å¤±æ•—å›å‘¼
                (err) => {
                    console.error(err);
                    let errMsg = "å®šä½å¤±æ•—";
                    
                    // æ ¹æ“šéŒ¯èª¤ä»£ç¢¼çµ¦å‡ºå…·é«”å»ºè­°
                    switch(err.code) {
                        case err.PERMISSION_DENIED:
                            errMsg = "æ¬Šé™è¢«æ‹’çµ•ï¼šè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š";
                            // æ•™å­¸æç¤º: é»æ“Šç¶²å€åˆ—é–é ­ -> æ¬Šé™ -> é‡è¨­
                            break;
                        case err.POSITION_UNAVAILABLE:
                            errMsg = "ç„¡æ³•å–å¾—ä½ç½®ï¼šè«‹ç¢ºèª GPS å·²é–‹å•Ÿ";
                            break;
                        case err.TIMEOUT:
                            errMsg = "å®šä½è¶…æ™‚ï¼šè«‹åœ¨ç©ºæ› è™•é‡è©¦";
                            break;
                    }
                    setStatus(errMsg, 'error');
                    document.getElementById('gps-btn').disabled = false;
                },
                // åƒæ•¸è¨­å®š (é—œéµä¿®æ­£)
                { 
                    enableHighAccuracy: true, // å˜—è©¦é«˜ç²¾ç¢ºåº¦
                    timeout: 20000,           // å»¶é•·åˆ° 20 ç§’ (è§£æ±ºè¶…æ™‚å•é¡Œ)
                    maximumAge: 0 
                }
            );
        }

        // --- åŠŸèƒ½ B: åŸ·è¡Œæœå°‹ ---
        function executeSearch() {
            // 1. å–å¾—åœ°é»
            const locationInput = document.getElementById('location-input');
            let locationVal = locationInput.value.trim();

            if (!locationVal) {
                // å¦‚æœæ²’å¡«ï¼Œé è¨­ç‚º "ç¥æˆ¶å¸‚" (æ ¹æ“šæ‚¨çš„éœ€æ±‚)
                // locationVal = "ç¥æˆ¶å¸‚"; 
                // æˆ–è€…å¼·åˆ¶ä½¿ç”¨è€…è¼¸å…¥ï¼š
                setStatus('è«‹è¼¸å…¥æˆ–å®šä½åœ°é»ï¼', 'error');
                locationInput.focus();
                return;
            }

            // æ›´æ–°åœ°åœ–é è¦½ (å¦‚æœæ˜¯æ‰‹å‹•è¼¸å…¥)
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationVal)}`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.length > 0) {
                        updateMap(parseFloat(data[0].lat), parseFloat(data[0].lon));
                    }
                });

            // 2. å–å¾—å‹¾é¸çš„äººç‰©
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            let selectedPeople = [];
            checkboxes.forEach((cb) => {
                selectedPeople.push(cb.value);
            });

            // 3. çµ„åˆæœå°‹å­—ä¸²
            let finalQuery = locationVal;
            if (selectedPeople.length > 0) {
                finalQuery += " " + selectedPeople.join(" ");
            }

            // 4. ç”¢ç”Ÿé€£çµ
            const googlePhotosUrl = `https://photos.google.com/search/${encodeURIComponent(finalQuery)}`;
            
            // é¡¯ç¤ºçµæœå€
            document.getElementById('search-query-preview').innerText = finalQuery;
            const finalLink = document.getElementById('final-link');
            finalLink.href = googlePhotosUrl;
            document.getElementById('result-area').classList.remove('hidden');

            setStatus('æ­£åœ¨é–‹å•Ÿç›¸ç°¿...', 'success');

            // å˜—è©¦è‡ªå‹•é–‹å•Ÿ
            setTimeout(() => {
                window.open(googlePhotosUrl, '_blank');
            }, 500);
        }
    </script>
</body>
</html>
